"use strict";var LogCollector=(()=>{function e(...s){return{unionMembers:s}}function c(s,t){return{props:s,additional:t}}function a(s){return{ref:s}}var b={SessionEvent:c([{json:"attributes",js:"attributes",typ:a("SessionAttributes")},{json:"endTimestamp",js:"endTimestamp",typ:e(void 0,3.14)},{json:"id",js:"id",typ:""},{json:"metrics",js:"metrics",typ:a("SessionMetrics")},{json:"startTimestamp",js:"startTimestamp",typ:3.14}],!1),SessionAttributes:c([{json:"fingerprint",js:"fingerprint",typ:""},{json:"ip",js:"ip",typ:""},{json:"isActive",js:"isActive",typ:!0},{json:"referrer",js:"referrer",typ:e(void 0,"")},{json:"type",js:"type",typ:a("SessionAttributesType")}],!1),SessionMetrics:c([{json:"actionCount",js:"actionCount",typ:3.14},{json:"timeSpent",js:"timeSpent",typ:3.14},{json:"viewCount",js:"viewCount",typ:3.14}],!1),ViewEvent:c([{json:"path",js:"path",typ:""},{json:"referrer",js:"referrer",typ:e(void 0,"")},{json:"sessionId",js:"sessionId",typ:""},{json:"timeSpent",js:"timeSpent",typ:3.14},{json:"timestamp",js:"timestamp",typ:3.14},{json:"title",js:"title",typ:e(void 0,"")},{json:"url",js:"url",typ:""}],!1),ActionEvent:c([{json:"sessionId",js:"sessionId",typ:""},{json:"target",js:"target",typ:e(void 0,"")},{json:"timestamp",js:"timestamp",typ:3.14},{json:"type",js:"type",typ:a("ActionEventType")}],!1),FetchEvent:c([{json:"data",js:"data",typ:a("Data")},{json:"type",js:"type",typ:a("FetchEventType")}],!1),Data:c([{json:"attributes",js:"attributes",typ:e(void 0,a("SessionAttributes"))},{json:"endTimestamp",js:"endTimestamp",typ:e(void 0,3.14)},{json:"id",js:"id",typ:e(void 0,"")},{json:"metrics",js:"metrics",typ:e(void 0,a("SessionMetrics"))},{json:"startTimestamp",js:"startTimestamp",typ:e(void 0,3.14)},{json:"path",js:"path",typ:e(void 0,"")},{json:"referrer",js:"referrer",typ:e(void 0,"")},{json:"sessionId",js:"sessionId",typ:e(void 0,"")},{json:"timeSpent",js:"timeSpent",typ:e(void 0,3.14)},{json:"timestamp",js:"timestamp",typ:e(void 0,3.14)},{json:"title",js:"title",typ:e(void 0,"")},{json:"url",js:"url",typ:e(void 0,"")},{json:"target",js:"target",typ:e(void 0,"")},{json:"type",js:"type",typ:e(void 0,a("ActionEventType"))}],!1),SessionAttributesType:["SYNTHETICS","USER"],ActionEventType:["CLICK","FORM_SUBMIT"],FetchEventType:["ACTION","SESSION","VIEW"]};function y(){let s=Date.now().toString(36),t=Math.random().toString(36).substring(2,8);return`${s}-${t}`}function m(){let s=window.sessionStorage.getItem("log_session_id");if(s)return s;let t=y();return window.sessionStorage.setItem("log_session_id",t),t}function l(s){document.addEventListener("click",t=>s.handleClick(t)),document.addEventListener("submit",t=>s.handleFormSubmit(t))}var p=class{constructor(t={}){this.events=[];this.initialized=!1;this.viewStartTime=0;this.currentPath="";this.currentUrl="";this.sessionStartTime=Date.now();this.viewCount=0;this.actionCount=0;this.endpoint=t.endpoint||"/api/logs",this.flushInterval=t.flushInterval||3e4,this.userId=t.userId,this.sessionId=m()}init(){this.initialized||(this.initialized=!0,this.flushIntervalId=window.setInterval(()=>this.flush(),this.flushInterval),this.trackSessionStart(),l(this),this.trackPageViewStart(),window.addEventListener("beforeunload",()=>{this.trackPageViewEnd(),this.trackSessionEnd(),this.flush()}),window.addEventListener("popstate",()=>{this.trackPageViewEnd(),this.trackPageViewStart()}))}trackSessionStart(){let t={fingerprint:this.generateFingerprint(),ip:"",isActive:!0,referrer:document.referrer||void 0,type:"USER"},n={actionCount:0,timeSpent:0,viewCount:0},r={attributes:t,id:this.sessionId,metrics:n,startTimestamp:this.sessionStartTime},o={type:"SESSION",data:r};this.events.push(o)}trackSessionEnd(){let t=Date.now()-this.sessionStartTime,n={fingerprint:this.generateFingerprint(),ip:"",isActive:!1,referrer:document.referrer||void 0,type:"USER"},r={actionCount:this.actionCount,timeSpent:t,viewCount:this.viewCount},o={attributes:n,id:this.sessionId,metrics:r,startTimestamp:this.sessionStartTime,endTimestamp:Date.now()},u={type:"SESSION",data:o};this.events.push(u)}trackPageViewStart(){this.viewStartTime=Date.now(),this.currentPath=window.location.pathname,this.currentUrl=window.location.href,this.viewCount++;let t={path:this.currentPath,sessionId:this.sessionId,timeSpent:0,timestamp:this.viewStartTime,url:this.currentUrl,title:document.title||void 0,referrer:document.referrer||void 0},n={type:"VIEW",data:t};this.events.push(n)}trackPageViewEnd(){if(this.viewStartTime===0)return;let t=Date.now()-this.viewStartTime,n={path:this.currentPath,sessionId:this.sessionId,timeSpent:t,timestamp:Date.now(),url:this.currentUrl,title:document.title||void 0,referrer:document.referrer||void 0},r={type:"VIEW",data:n};this.events.push(r)}handleClick(t){let n=t.target;this.actionCount++;let r={sessionId:this.sessionId,timestamp:Date.now(),type:"CLICK",target:n.id||n.tagName||void 0},o={type:"ACTION",data:r};this.events.push(o)}handleFormSubmit(t){let n=t.target;this.actionCount++;let r={sessionId:this.sessionId,timestamp:Date.now(),type:"FORM_SUBMIT",target:n.id||n.name||"unnamed_form"},o={type:"ACTION",data:r};this.events.push(o)}flush(){if(this.events.length===0)return;let t=[...this.events];this.events=[],fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0}).catch(n=>{console.error("Failed to send logs:",n),this.events=[...t,...this.events]})}destroy(){this.flushIntervalId&&window.clearInterval(this.flushIntervalId),this.trackPageViewEnd(),this.trackSessionEnd(),this.flush()}generateFingerprint(){let t={userAgent:navigator.userAgent,language:navigator.language,screenResolution:`${screen.width}x${screen.height}`,colorDepth:screen.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,hardwareConcurrency:navigator.hardwareConcurrency||"unknown",deviceMemory:navigator.deviceMemory||"unknown"};function n(r){let o=Object.entries(r).map(([v,S])=>`${v}:${S}`).join("|"),u=0,d,f;for(d=0;d<o.length;d++)f=o.charCodeAt(d),u=(u<<5)-u+f,u|=0;return Math.abs(u).toString(36).padStart(10,"0").slice(0,32)}return n(t)}};var i=document.currentScript,g=(i==null?void 0:i.getAttribute("data-endpoint"))||"/api/logs",j=i!=null&&i.hasAttribute("data-flush-interval")?parseInt(i.getAttribute("data-flush-interval"),10):void 0,E=(i==null?void 0:i.getAttribute("data-user-id"))||void 0,h=new p({endpoint:g,flushInterval:j,userId:E});window.LogCollector=h;(i==null?void 0:i.getAttribute("data-auto-init"))!=="false"&&h.init();})();
